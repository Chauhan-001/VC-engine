<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>In-Browser Image Compressor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for better aesthetics */
        .scrolly::-webkit-scrollbar { width: 8px; }
        .scrolly::-webkit-scrollbar-track { background: #f1f5f9; }
        .scrolly::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .scrolly::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Custom styling for the file input area */
        .file-input-wrapper {
            transition: all 0.2s ease-in-out;
        }
        .file-input-wrapper:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-color: #3b82f6; /* Blue-500 */
        }
        /* Fade-in effect for the results panel */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.4s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <div class="w-full max-w-5xl bg-white shadow-2xl rounded-xl p-6 md:p-10 border border-gray-100">

        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-blue-800">Gemini Image Compressor</h1>
            <p class="text-gray-500 mt-2">Lossy JPEG compression performed locally in your browser.</p>
        </header>

        <!-- Main Grid Layout: Controls (1/3) and Preview (2/3) -->
        <div class="md:grid md:grid-cols-3 gap-12">

            <!-- Control & Results Panel (Column 1) -->
            <div class="md:col-span-1 space-y-6">

                <!-- File Input Card -->
                <div class="p-6 bg-gray-50 rounded-xl shadow-inner border border-gray-200 file-input-wrapper">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">1. Select & Adjust</h2>

                    <!-- File Input -->
                    <div class="mb-6">
                        <label for="image-file" class="block text-sm font-medium text-gray-700 mb-2">Image File (JPG or PNG)</label>
                        <input type="file" id="image-file" accept="image/jpeg, image/png" class="block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-blue-100 file:text-blue-700
                            hover:file:bg-blue-200"
                            onchange="handleFileChange(event)">
                    </div>

                    <!-- Quality Slider -->
                    <div>
                        <label for="quality-slider" class="block text-sm font-medium text-gray-700 mb-2">Compression Quality</label>
                        <div class="flex items-center space-x-4">
                            <input type="range" id="quality-slider" min="10" max="100" value="80" step="5"
                                   class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer range-lg"
                                   oninput="updateQualityValue(this.value)">
                            <span id="quality-value" class="text-xl font-extrabold text-blue-700 w-12 text-right">80</span>
                            <span class="text-lg text-gray-500">%</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">10 (Max Compression) to 100 (Original Quality)</p>
                    </div>

                    <!-- Explicit Re-Compress Button (Optional but useful for mobile interaction) -->
                    <button onclick="compressImage()" id="compress-btn" disabled
                            class="mt-6 w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md
                                   hover:bg-blue-700 transition duration-150 disabled:bg-blue-400 disabled:cursor-not-allowed">
                        <span id="btn-text">Load Image to Compress</span>
                    </button>
                </div>

                <!-- Results & Download Card -->
                <div id="results-panel" class="p-6 bg-white rounded-xl shadow-xl border border-blue-400/50 hidden">
                    <h2 class="text-xl font-semibold text-blue-700 mb-4">2. Compression Results</h2>

                    <!-- Size Comparison Block (Enhanced Visual Feedback) -->
                    <div class="grid grid-cols-2 gap-4 text-center mb-6">
                        <!-- Original Size -->
                        <div class="p-3 bg-gray-100 rounded-lg border border-gray-300">
                            <p class="text-xs font-medium text-gray-500">Original Size</p>
                            <p id="original-size" class="text-lg font-bold text-gray-700">---</p>
                        </div>
                        <!-- Compressed Size -->
                        <div class="p-3 bg-green-50 rounded-lg border border-green-300">
                            <p class="text-xs font-medium text-green-700">Compressed Size</p>
                            <p id="compressed-size" class="text-lg font-bold text-green-800">---</p>
                        </div>
                    </div>

                    <!-- Reduction Percentage -->
                    <div class="text-center p-3 mb-6 bg-blue-100 rounded-lg shadow-inner">
                        <p class="text-sm font-medium text-blue-700">Total File Size Reduction</p>
                        <p id="reduction-percent" class="text-3xl font-extrabold text-blue-800 mt-1">---</p>
                    </div>

                    <!-- Download Button -->
                    <a id="download-link" href="#" download="compressed_image.jpg"
                       class="w-full text-center block py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg
                              hover:bg-green-700 transition duration-150">
                        Download Compressed Image
                    </a>
                </div>

            </div>

            <!-- Preview Area (Columns 2 & 3) -->
            <div class="md:col-span-2 space-y-6 mt-8 md:mt-0">
                <h2 class="text-2xl font-semibold text-gray-700">3. Visual Comparison</h2>

                <!-- Container for Original and Compressed Previews -->
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- Original Image Card -->
                    <div class="bg-white p-4 rounded-xl border border-gray-300 shadow-md">
                        <h3 class="font-medium text-gray-600 mb-2">Original</h3>
                        <div class="w-full h-64 flex items-center justify-center bg-gray-200 rounded-lg overflow-hidden scrolly">
                            <img id="original-preview" class="max-w-full max-h-full object-contain" src="https://placehold.co/400x300/e0e7ff/3730a3?text=Original+Image" onerror="this.src='https://placehold.co/400x300/e0e7ff/3730a3?text=Original+Image'" alt="Original Image Preview">
                        </div>
                    </div>

                    <!-- Compressed Image Card -->
                    <div class="bg-white p-4 rounded-xl border border-blue-400/50 shadow-md">
                        <h3 class="font-medium text-blue-600 mb-2">Compressed (Quality: <span id="preview-quality">80</span>%)</h3>
                        <div class="w-full h-64 flex items-center justify-center bg-blue-100 rounded-lg overflow-hidden scrolly">
                            <img id="compressed-preview" class="max-w-full max-h-full object-contain" src="https://placehold.co/400x300/bfdbfe/1d4ed8?text=Compressed+Image" onerror="this.src='https://placehold.co/400x300/bfdbfe/1d4ed8?text=Compressed+Image'" alt="Compressed Image Preview">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Canvas for Processing -->
    <canvas id="image-canvas" class="hidden"></canvas>

    <script>
        // Global variables for file handling
        let uploadedFile = null;
        let originalFileSize = 0;
        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const resultsPanel = document.getElementById('results-panel');
        const downloadLink = document.getElementById('download-link');

        // Utility function to format file size
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        // Updates the quality percentage displayed next to the slider and in the preview
        function updateQualityValue(value) {
            document.getElementById('quality-value').textContent = value;
            document.getElementById('preview-quality').textContent = value;
            if (uploadedFile) {
                // Re-compress automatically when slider changes, if an image is loaded
                compressImage();
            }
        }

        // Handles the file selection event
        function handleFileChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Reset status display (hiding the entire panel is sufficient)
            resultsPanel.classList.add('hidden');
            // Removed redundant downloadLink.classList.add('hidden') here.

            uploadedFile = file;
            originalFileSize = file.size;
            document.getElementById('original-size').textContent = formatBytes(originalFileSize);

            const reader = new FileReader();
            reader.onload = function(e) {
                // Display original preview
                document.getElementById('original-preview').src = e.target.result;
                document.getElementById('compress-btn').disabled = false;
                document.getElementById('btn-text').textContent = 'Re-Compress Image';

                // Automatically compress on load
                compressImage();
            };
            reader.readAsDataURL(file);
        }

        // Main compression logic
        function compressImage() {
            if (!uploadedFile) {
                console.error("No file selected.");
                return;
            }

            const quality = parseInt(document.getElementById('quality-slider').value) / 100;
            const compressBtn = document.getElementById('compress-btn');
            const btnText = document.getElementById('btn-text');

            btnText.textContent = 'Compressing...';
            compressBtn.disabled = true;

            const img = new Image();
            // Added crossOrigin for robustness with canvas operations
            img.crossOrigin = "Anonymous"; 
            
            img.onload = function() {
                let compressedDataUrl = null;
                
                try {
                    // 1. Set canvas dimensions to match the image
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // 2. Draw the image onto the canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0, img.width, img.height);

                    // 3. Perform JPEG compression (lossy)
                    compressedDataUrl = canvas.toDataURL('image/jpeg', quality);

                    // 4. Update UI with results
                    document.getElementById('compressed-preview').src = compressedDataUrl;

                    // Calculate compressed size from Data URL
                    const base64Content = compressedDataUrl.split(',')[1];
                    const compressedFileSize = Math.round(base64Content.length * 0.75); // Base64 size approximation

                    let reduction = 0;
                    if (originalFileSize > 0) {
                         reduction = 100 - (compressedFileSize / originalFileSize) * 100;
                    }

                    // Update status area
                    document.getElementById('compressed-size').textContent = formatBytes(compressedFileSize);
                    document.getElementById('reduction-percent').textContent = reduction.toFixed(2) + '% SAVED';
                    console.log("Compression successful. Size:", formatBytes(compressedFileSize));


                } catch (e) {
                    console.error("Compression Error:", e);
                    // Set error status in UI
                    document.getElementById('compressed-size').textContent = "Error";
                    document.getElementById('reduction-percent').textContent = "Failed";
                } finally {
                    // This block runs regardless of errors, guaranteeing the UI updates
                    
                    if (compressedDataUrl) {
                        // Update download link
                        downloadLink.href = compressedDataUrl;
                        downloadLink.download = `compressed_${uploadedFile.name.split('.')[0]}_q${quality * 100}.jpg`;
                    } else {
                         // Fallback for download link if compression failed
                         downloadLink.href = "#";
                         downloadLink.download = "error.txt";
                    }

                    resultsPanel.classList.remove('hidden');
                    resultsPanel.classList.add('animate-fadeIn'); // Trigger fade-in animation

                    btnText.textContent = 'Re-Compress Image';
                    compressBtn.disabled = false;
                }
            };

            img.onerror = function() {
                 console.error("Image failed to load into canvas. This typically points to an issue with the Data URL or its source.");
                 // Force UI to show an error state and enable the button
                 document.getElementById('compressed-size').textContent = "Load Error";
                 document.getElementById('reduction-percent').textContent = "Failed";
                 resultsPanel.classList.remove('hidden');
                 resultsPanel.classList.add('animate-fadeIn');
                 btnText.textContent = 'Error Loading Image';
                 compressBtn.disabled = false;
            }

            // This sets the source for the Image object to load using the Data URL 
            // set in handleFileChange.
            img.src = document.getElementById('original-preview').src;
            console.log("Attempting to load image source into Image object.");
        }

        // Initial setup for the slider
        updateQualityValue(document.getElementById('quality-slider').value);

        // Listen for user finishing interaction with the slider (mouse/touch lift)
        document.getElementById('quality-slider').addEventListener('mouseup', function() {
            if (uploadedFile) {
                compressImage();
            }
        });
        document.getElementById('quality-slider').addEventListener('touchend', function() {
            if (uploadedFile) {
                compressImage();
            }
        });

    </script>
</body>
</html>
